# roles/ssh_users/tasks/user_keys_install.yml

- name: "Resolve authorized key file paths for {{ ssh_user.name }}"
  ansible.builtin.set_fact:
    ssh_user_key_file_paths: >-
      {{
        (ssh_user.authorized_key_files | default([]))
        | map('regex_replace', '^(?!/)', ssh_user_key_local_dir + '/')
        | list
      }}

- name: "Initialize authorized key file results for {{ ssh_user.name }}"
  ansible.builtin.set_fact:
    ssh_user_key_files:
      results: []

- name: "Read authorized key files for {{ ssh_user.name }}"
  ansible.builtin.slurp:
    src: "{{ item }}"
  delegate_to: localhost
  become: false
  register: ssh_user_key_files
  loop: "{{ ssh_user_key_file_paths }}"
  when: ssh_user_key_file_paths | length > 0

- name: "Assemble authorized keys for {{ ssh_user.name }}"
  ansible.builtin.set_fact:
    ssh_user_authorized_keys_combined: >-
      {{
        (ssh_user.authorized_keys | default([]))
        + (ssh_user_key_files.results | default([])
           | map(attribute='content')
           | map('b64decode')
           | map('trim')
           | reject('equalto', '')
           | list)
      }}

- name: "Ensure .ssh directory exists for {{ ssh_user.name }}"
  ansible.builtin.file:
    path: "{{ ssh_user_home }}/.ssh"
    state: directory
    owner: "{{ ssh_user.name }}"
    group: "{{ ssh_user.name }}"
    mode: "0700"
  when: ssh_user_authorized_keys_combined | length > 0

- name: "Write authorized_keys for {{ ssh_user.name }}"
  ansible.builtin.copy:
    dest: "{{ ssh_user_home }}/.ssh/authorized_keys"
    owner: "{{ ssh_user.name }}"
    group: "{{ ssh_user.name }}"
    mode: "0600"
    content: "{{ ssh_user_authorized_keys_combined | join('\n') + '\n' }}"
  when: ssh_user_authorized_keys_combined | length > 0
