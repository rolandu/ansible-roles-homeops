# roles/ssh_users/tasks/main.yml

- name: "Validate ssh_users variable"
  ansible.builtin.assert:
    that:
      - ssh_users is defined
      - ssh_users | default([]) | type_debug == "list"
    fail_msg: "Define ssh_users as a list before including the ssh_users role."

- name: "Configure SSH users"
  ansible.builtin.debug:
    msg: "Users: {{ ssh_users | map(attribute='name') | list }}"
  when: ssh_users | length > 0

# Create/update the users
- name: "Manage SSH users"
  ansible.builtin.include_tasks: manage_user.yml
  loop: "{{ ssh_users }}"
  loop_control:
    loop_var: ssh_user
    label: "{{ ssh_user.name }}"

# Ensure .ssh directory
- name: "Ensure .ssh directory exists"
  ansible.builtin.file:
    path: "{{ user_home }}/.ssh"
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: "0700"
  vars:
    user_home: "{{ item.home | default('/home/' + item.name) }}"
  loop: "{{ ssh_users }}"
  when:
    - item.authorized_keys is defined
    - item.authorized_keys | length > 0
  loop_control:
    label: "{{ item.name }}"

# Install keys
# This method is better than the built-in ansible.posix.authorized_key because it also
# handles removing keys that are no longer wanted.
- name: "Write authorized_keys"
  ansible.builtin.copy:
    dest: "{{ user_home }}/.ssh/authorized_keys"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: "0600"
    content: "{{ (item.authorized_keys | default([])) | join('\n') + '\n' }}"
  vars:
    user_home: "{{ item.home | default('/home/' + item.name) }}"
  loop: "{{ ssh_users }}"
  when:
    - item.authorized_keys is defined
    - item.authorized_keys | length > 0
  loop_control:
    label: "{{ item.name }}"

# Include Ops User Setup tasks
- name: "Set up user for passwordless sudo operations (if defined)"
  ansible.builtin.include_tasks: ops_user_setup.yml
  when: 
    - ops_user is defined
    - ops_user is not none
    - ops_user | string | length > 0

# Include SSH hardening tasks
- name: "SSH hardening tasks"
  ansible.builtin.include_tasks: hardening.yml

