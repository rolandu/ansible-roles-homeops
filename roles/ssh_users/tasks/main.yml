# roles/ssh_users/tasks/main.yml

- name: "Validate ssh_users variable"
  ansible.builtin.assert:
    that:
      - ssh_users is defined
      - ssh_users | default([]) | type_debug == "list"
    fail_msg: "Define ssh_users as a list before including the ssh_users role."

- name: "Configure SSH users"
  ansible.builtin.debug:
    msg: "Users: {{ ssh_users | map(attribute='name') | list }}"
  when: ssh_users | length > 0

# Create/update the users
- name: "Manage SSH users"
  ansible.builtin.include_tasks: manage_user.yml
  loop: "{{ ssh_users }}"
  loop_control:
    loop_var: ssh_user
    label: "{{ ssh_user.name }}"

# Generate SSH keys and export public keys to controller
- name: "Generate SSH user keys"
  ansible.builtin.include_tasks: user_keys_generate.yml
  loop: "{{ ssh_users }}"
  loop_control:
    loop_var: ssh_user
    label: "{{ ssh_user.name }}"
  vars:
    ssh_user_home: "{{ ssh_user.home | default('/home/' + ssh_user.name) }}"
    ssh_user_generate_key: "{{ ssh_user.generate_ssh_key | default(ssh_users_generate_keys) }}"
    ssh_user_key_filename: "{{ ssh_user.ssh_key_filename | default(ssh_users_key_filename) }}"
    ssh_user_key_type: "{{ ssh_user.ssh_key_type | default(ssh_users_key_type) }}"
    ssh_user_key_comment: "{{ ssh_user.ssh_key_comment | default(ssh_user.name + '@' + inventory_hostname) }}"
    ssh_user_key_path: "{{ ssh_user_home }}/.ssh/{{ ssh_user_key_filename }}"
    ssh_user_key_local_dir: "{{ ssh_users_key_local_dir }}"
  when: ssh_user.state | default('present') != 'absent'

# Install authorized_keys after all keys are generated/exported
- name: "Install SSH user authorized_keys"
  ansible.builtin.include_tasks: user_keys_install.yml
  loop: "{{ ssh_users }}"
  loop_control:
    loop_var: ssh_user
    label: "{{ ssh_user.name }}"
  vars:
    ssh_user_home: "{{ ssh_user.home | default('/home/' + ssh_user.name) }}"
    ssh_user_key_local_dir: "{{ ssh_users_key_local_dir }}"
  when: ssh_user.state | default('present') != 'absent'

# Include Ops User Setup tasks
- name: "Set up user for passwordless sudo operations (if defined)"
  ansible.builtin.include_tasks: ops_user_setup.yml
  when: 
    - ops_user is defined
    - ops_user is not none
    - ops_user | string | length > 0

# Include SSH hardening tasks
- name: "SSH hardening tasks"
  ansible.builtin.include_tasks: hardening.yml
