---
- name: Install OpenVPN client package
  apt:
    name: openvpn
    state: present
    update_cache: yes

- name: Detect systemd unit style (openvpn-client@ or openvpn@)
  stat:
    path: "/lib/systemd/system/openvpn-client@.service"
  register: _client_unit

- name: Detect legacy unit
  stat:
    path: "/lib/systemd/system/openvpn@.service"
  register: _legacy_unit

- name: Set service unit and config directory
  set_fact:
    openvpn_client_systemd_unit: >-
      {{ 'openvpn-client@' + openvpn_client_name if _client_unit.stat.exists else 'openvpn@' + openvpn_client_name }}
    openvpn_client_conf_dir: >-
      {{ '/etc/openvpn/client' if _client_unit.stat.exists else '/etc/openvpn' }}

- name: Ensure client config directory exists
  file:
    path: "{{ openvpn_client_conf_dir }}"
    state: directory
    mode: "0755"

- name: Ensure local export directory exists on controller (for safety)
  delegate_to: localhost
  file:
    path: "{{ openvpn_client_local_dir }}"
    state: directory
    mode: "0700"

- name: Copy inline .ovpn from controller to target as .conf
  copy:
    src: "{{ openvpn_client_local_dir }}/{{ openvpn_client_name }}.ovpn"
    dest: "{{ openvpn_client_conf_dir }}/{{ openvpn_client_name }}.conf"
    owner: root
    group: root
    mode: "0600"

- name: Enable IPv4 forwarding (gateway mode)
  when: openvpn_client_enable_ip_forward | bool
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    state: present
    reload: yes

- name: Enable and start OpenVPN client service
  service:
    name: "{{ openvpn_client_systemd_unit }}"
    enabled: yes
    state: started

