---
- name: Ensure VPN definitions are provided
  assert:
    that:
      - openvpn_config is defined
      - (openvpn_config | default([])) | length > 0
    fail_msg: "Set openvpn_config to the list of VPN definitions."

- name: Validate required fields per VPN definition
  assert:
    that:
      - item.vpn_name is defined
      - item.vpn_name | string | trim | length > 0
      - item.server_hostname is defined
      - item.server_hostname | string | trim | length > 0
      - item.network is defined
      - item.network | string | trim | length > 0
      - item.netmask is defined
      - item.netmask | string | trim | length > 0
      - item.openvpn_ca_passphrase is defined
      - item.openvpn_ca_passphrase | string | trim | length > 0
      - item.openvpn_mgmt_password is defined
      - item.openvpn_mgmt_password | string | trim | length > 0
    fail_msg: "Each VPN entry must define vpn_name, server_hostname, network, netmask, openvpn_ca_passphrase, and openvpn_mgmt_password."
  loop: "{{ openvpn_config }}"
  loop_control:
    label: "{{ item.vpn_name | default(item.server_hostname | default('undefined')) }}"

- name: Configure OpenVPN server instances
  include_tasks: server_instance.yml
  loop: "{{ openvpn_config | default([]) }}"
  loop_control:
    loop_var: ovpn_server
  when: >
    (ovpn_server.server_hostname | default(inventory_hostname)) in [
      inventory_hostname,
      ansible_hostname | default(inventory_hostname),
      ansible_fqdn | default(inventory_hostname)
    ]
